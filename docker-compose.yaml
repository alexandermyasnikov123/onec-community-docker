version: '3.8'

services:
  1c-server:
    build:
      dockerfile: ./1c-server/Dockerfile
      args:
        - PLATFORM_VERSION=${PLATFORM_VERSION}
        - PLATFORM_ARCH=${PLATFORM_ARCH}
        - SERVER_COMPONENTS=${SERVER_COMPONENTS}
    container_name: ${SERVER_HOST}
    hostname: ${SERVER_HOST}
    volumes:
      # Монтируем общий каталог с лицензиями в служебный путь сервера
      - ./shared_data/licenses:/var/1C/licenses
      # Можно добавить том для данных
      # - 1c_data:/var/1C/1cv8
    ports:
      - "${SERVER_PORT}:${SERVER_PORT}"
      - "${SERVER_AGENT_PORT}:${SERVER_AGENT_PORT}"
    env_file:
      - .env
    networks:
      - 1c-network
    restart: unless-stopped

  1c-client:
    build:
      dockerfile: ./1c-client/Dockerfile
      args:
        - PLATFORM_VERSION=${PLATFORM_VERSION}
        - PLATFORM_ARCH=${PLATFORM_ARCH}
        - CLIENT_COMPONENTS=${CLIENT_COMPONENTS}
    container_name: ${CLIENT_HOST}
    hostname: ${CLIENT_HOST}
    volumes:
      # Монтируем тот же каталог с лицензиями в путь клиента
      - ./shared_data/licenses:/var/shared_licenses
      # Пробрасываем сокет X11 для отображения графического интерфейса[citation:2]
      - /tmp/.X11-unix:/tmp/.X11-unix
      - ${HOME}/.Xauthority:/home/user/.Xauthority:ro
      - ./client_home:/home/1c_user:rw
    environment:
      - DISPLAY=${DISPLAY}
      - USER=1c_user
    env_file:
      - .env
    networks:
      - 1c-network
    depends_on:
      - 1c-server
    stdin_open: true
    tty: true

# volumes:
#   1c_data:

networks:
  1c-network:
    driver: bridge
