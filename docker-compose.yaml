services:
  1c-postgres:
    image: akocur/postgresql-1c-17
    container_name: 1c-postgres
    volumes:
      - 1c-postgres_data:/var/lib/pgpro/1c-17/data
    ports:
      - $ONEC_PG_PORT:5432
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U postgres" ]
      start_period: 2s
      start_interval: 1s
      interval: 5s
      timeout: 5s
      retries: 3
    restart: no

  1c-server:
    build:
      dockerfile: ./1c-server/Dockerfile
      args:
        - PLATFORM_VERSION=$PLATFORM_VERSION
    container_name: 1c-server
    hostname: 1c-server
    env_file:
      - .env
    depends_on:
      1c-postgres:
        condition: service_healthy
    ports:
      - $SERVER_PORT:1540
      - $SERVER_AGENT_PORT:1541
      - $SERVER_WEB_ADMIN_PORT:1542
    volumes:
      - 1c-server_opt:/1c_dir
      - 1c-server_licenses:/1c_licenses
      - 1c-server_data:/home/usr1cv8
    restart: no

  1c-client:
    build:
      dockerfile: ./1c-client/Dockerfile
      args:
        - PLATFORM_VERSION=$PLATFORM_VERSION
    container_name: 1c-client
    hostname: 1c-client
    env_file:
      - .env
    environment:
      - DISPLAY=$DISPLAY
      - XAUTHORITY=/tmp/.docker.xauth
      - QT_X11_NO_MITSHM=1
      - _X11_NO_MITSHM=1
      - _MITSHM=0
    depends_on:
      - 1c-server
    volumes:
      - 1c-client_home:/home/usr1cv8
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${XAUTHORITY}:/tmp/.docker.xauth:rw
      - ${HOME}/.Xauthority:/root/.Xauthority:ro
    stdin_open: true
    tty: true
    restart: no

volumes:
  1c-postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${BASE_MOUNT_DIR}/data/1c-postgres_data

  1c-server_opt:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${BASE_MOUNT_DIR}/data/1c-server_opt

  1c-server_licenses:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${BASE_MOUNT_DIR}/data/1c-server_licenses

  1c-server_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${BASE_MOUNT_DIR}/data/1c-server_data

  1c-client_home:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${BASE_MOUNT_DIR}/data/1c-client_home
